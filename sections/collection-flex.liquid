<section class="col">
  <div class="page-inner">
    <div class="page-contents">
      <div class="col-area">
        <!-- 背景オーバーレイ -->
        <div id="js-drawer-overlay" class="drawer-overlay" aria-hidden="true"></div>
        <!-- ドロワー（既存 aside 部分を移動） -->

        <aside class="col-aside" id="js-drawer" role="dialog" aria-label="絞り込み">
          <button class="drawer-close" id="js-drawer-close" aria-label="閉じる">×</button>
          <div class="col-headArea">
            <p class="col-caption">対象商品数</p>
            <p class="col-result"><span class="-strong">{{ collection.products_count }}</span>件</p>
          </div>

          <div class="col-bodyArea">
            {%- for block in section.blocks -%}
              {% if block.type == 'custom_link' %}
                {% if block.settings.collection %}
                  <div class="aside-category">
                    <h3 class="aside-cat__title">{{ block.settings.theme-title }}</h3>
                    <ul class="aside-cat__lists">
                      <li><a href="{{ block.settings.collection.url }}" class="aside-cat__list">{{ block.settings.title }}</a></li>
                    </ul>
                  </div>
                {% endif %}
              {% endif %}
            {% endfor %}

            {%- for block in section.blocks -%}
              {% if block.type == 'category_group' %}
                <div class="aside-category">
                  <h3 class="aside-cat__title">{{ block.settings.heading }}</h3>
                  <ul class="aside-cat__lists">
                    {%- assign tag_list = '' -%}
                    {%- for product in collection.products -%}
                      {% if product.tags contains block.settings.tag_name %}
                        {% assign tag_list = tag_list | append: product.title | append: '||' | append: product.url | append: ',' %}
                      {% endif %}
                    {%- endfor -%}
                    {%- assign tag_array = tag_list | split: ',' | uniq -%}
                    {%- for tag_item in tag_array -%}
                      {% unless tag_item == '' %}
                        {% assign parts = tag_item | split: '||' %}
                        <li>
                          <a href="{{ parts[1] }}" class="aside-cat__list">
                            {{ parts[0] }}
                          </a>
                        </li>
                      {% endunless %}
                    {%- endfor -%}
                  </ul>
                </div>
              {% endif %}
            {%- endfor -%}

          </div>
        </aside>

        <div class="col-main">
          {% paginate collection.products by 100 %}
            <div class="col-headArea__main">

              <!-- SP用フィルターボタン -->
              <button id="js-drawer-toggle" class="drawer-toggle" aria-expanded="false" aria-controls="js-drawer">
                <img src="{{ 'icon-filters.png' | asset_url }}" alt="絞り込み" class="col-filter__icon">
              </button>

              <p class="col-caption">
                <span>{{ paginate.items }}</span>件中
                <span>{{ paginate.current_offset | plus: 1 }}</span>件〜
                <span>{{ paginate.current_offset | plus: paginate.page_size | at_most: paginate.items }}</span>件を表示
              </p>
              <div class="col-search" >
                <p class="col-filters">並び替え</p>
                <img src="{{ 'arrow-down.png' | asset_url }}" alt="arrow-down" class="arrow-down" id="js-toggle-sort">
                <div class="sort-options" id="js-sort-options">
                  <a href="?sort_by=title-ascending" class="sort-option" >アルファベット順, A-Z</a>
                  <a href="?sort_by=title-descending"class="sort-option" >アルファベット順, Z-A</a>
                  <a href="?sort_by=price-ascending"class="sort-option" >価格が安い順</a>
                  <a href="?sort_by=price-descending"class="sort-option" >価格が高い順</a>
                  <a href="?sort_by=created-descending"class="sort-option" >新着順</a>
                </div>
              </div>
            </div>

            <div class="col-bodyArea">
              <ul class="col-items">
                {% for product in collection.products %}
                  <li class="col-item">
                    <a href="{{ product.url }}">
                      <div class="option-add__imgWrap">
                        <img src="{{ product |  image_url: width: 213  }}" alt="index-img" class="col-product__img">

                        {% for tag in product.tags %}
                          {% if tag contains "sale_" %}
                            <div class="option-add__tag">
                              <p><span class="c-btn__labelSo">{{ tag | split: "_" | last }}</span></p>
                            </div>
                          {% elsif tag contains "out_" %}
                            <div class="option-add__tag">
                              <p><span class="c-btn__labelSo">{{ tag | split:"_" | last }}</span></p>
                            </div>
                          {% endif %}
                        {% endfor %}
                      </div>

                      <div class="top-rec__textArea">
                        <h3 class="product-name">{{ product.title }}</h3>
                        {% if product.metafields.custom.color != blank %}
                          <div class="product-item"> {{ product.metafields.custom.color | metafield_text }}</div>
                        {% endif %}
                        {% if product.metafields.custom.capacity != blank %}
                          <div class="product-item"> {{ product.metafields.custom.capacity | metafield_text }}</div>
                        {% endif %}
                        <div class="product-price">
                          {% if product.compare_at_price > product.price %}
                            <div class="product-old-price" style="text-decoration: line-through; color: #888;">
                              {{ product.compare_at_price | money }}<span class="product-price">円</span>
                            </div>
                          {% endif %}
                          <div class="product-emphasis">
                            {{ product.price | money }}<span class="product-price"> 円（税込）</span>
                          </div>
                        </div>
                      </div>
                    </a>
                    <div class="product-tag__discountArea">
                      {% for tag in product.tags %}
                        {% if tag contains "info_" %}
                          <div class="product-tag__discountTag">
                            <p><span class="c-btn__labelSo">{{ tag | split: "_" | last }}</span></p>
                          </div>
                        {% endif %}
                      {% endfor %}
                    </div>
                  </li>
                {% endfor %}
              </ul>

              {% if paginate.pages > 1 %}
                <div class="col-paginationArea">
                  <ul class="product-paginations">
                    {% for part in paginate.parts %}
                      <li>
                        {% if part.is_link %}
                          <a href="{{ part.url }}" class="product-pagination">{{ part.title }}</a>
                          {% elsif part.title == '...' %}
                            <span class="product-pagination">…</span>
                          {% else %}
                            <span class="product-pagination is-current">{{ part.title }}</span>
                        {% endif %}
                      </li>
                    {% endfor %}
                  </ul>
                </div>
              {% endif %}

            </div>
          {% endpaginate %}
        </div>
      </div>

    </div>
  </div>
</section>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    /* 並び替えポップアップ処理
    =========================== */
    function initSortPopup() {
      const arrow = document.getElementById('js-toggle-sort');
      const sortOptions = document.getElementById('js-sort-options');

      if (!arrow || !sortOptions) return;

      arrow.addEventListener('click', () => {
        arrow.classList.toggle('active');
        sortOptions.classList.toggle('active');
      });

      // クリック外で閉じる
      document.addEventListener('click', (e) => {
        if (!e.target.closest('.col-search')) {
          arrow.classList.remove('active');
          sortOptions.classList.remove('active');
        }
      });
    }

    /* ドロワー開閉処理
    =========================== */
    function initDrawer() {
      const toggle = document.getElementById('js-drawer-toggle');
      const drawer = document.getElementById('js-drawer');
      const overlay = document.getElementById('js-drawer-overlay');
      const closeBtn = document.getElementById('js-drawer-close');

      if (!toggle || !drawer || !overlay) return;

      const open = () => {
        drawer.classList.add('is-open');
        overlay.classList.add('is-visible');
        toggle.setAttribute('aria-expanded', 'true');
        overlay.setAttribute('aria-hidden', 'false');
      };

      const close = () => {
        drawer.classList.remove('is-open');
        overlay.classList.remove('is-visible');
        toggle.setAttribute('aria-expanded', 'false');
        overlay.setAttribute('aria-hidden', 'true');
      };

      toggle.addEventListener('click', () => {
        drawer.classList.contains('is-open') ? close() : open();
      });
      overlay.addEventListener('click', close);
      if (closeBtn) closeBtn.addEventListener('click', close);

      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && drawer.classList.contains('is-open')) close();
      });
    }

    // 初期化呼び出し
    initSortPopup();
    initDrawer();
  });
</script>

{% schema %}
{
  "name": "一覧",
  "tag": "section",
  "disabled_on": {
    "groups": ["header", "footer"]
  },
  "settings": [
    {
      "type": "collection",
      "id":"index",
      "label": "商品一覧"
    },
  ],
  "blocks": [
    {
      "type": "custom_link",
      "name": "コレクションリンク",
      "settings": [
        {
          "type": "text",
          "id": "theme-title",
          "label": "テーマタイトル"
        },
        {
          "type": "collection",
          "id": "collection",
          "label": "リンク先コレクション"
        },
        {
          "type": "text",
          "id": "title",
          "label": "リンク名"
        },
      ]
    },
    {
      "type": "category_group",
      "name": "カテゴリグループ",
      "settings": [
        {
          "type": "text",
          "id": "heading",
          "label": "見出し（例：カラー、ブランド、テーマなど）"
        },
        {
        "type": "text",
        "id": "tag_name",
        "label": "タグ名（例：summer, blue, brand-x など）"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "商品インデックス",
      "blocks": [
        {
          "type": "custom_link",
          "settings": {
            "title": "カラー別",
          }
        }
      ]
    }
  ]
}
{% endschema %}
